<app-navbar></app-navbar>
<div class="container mt-4">
  <div class="titulo bg-primary text-white p-3 mb-4 " >
    <h2>Editar Orden de Producción</h2>
  </div>

  <div class="alert alert-info" *ngIf="loading">
    <i class="fas fa-spinner fa-spin"></i> Cargando producto...
  </div>

  <form (ngSubmit)="onSubmit(productForm)" #productForm="ngForm" novalidate>
    <div class="alert alert-danger" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>
    
    <div class="row">
      
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="productDescription">Descripción</label>
          <input
            type="text"
            id="description"
            [(ngModel)]="product.description"
            name="descripcion"
            class="form-control">
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="referencia">Referencia</label>
          <input
            type="number"
            id="referencia"
            [(ngModel)]="product.referencia"
            name="referencia"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.referencia"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.referencia"
          >
            La referencia es requerida
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="fechaAsignada">Fecha Asignada</label>
          <input
            type="date"
            id="fechaAsignada"
            [(ngModel)]="product.fechaAsignada"
            name="fechaAsignada"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.fechaAsignada"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.fechaAsignada"
          >
            La fecha asignada es requerida
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="fechaEntrada">Fecha Entrada</label>
          <input
            type="date"
            id="fechaEntrada"
            [(ngModel)]="product.fechaEntrada"
            name="fechaEntrada"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.fechaEntrada"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.fechaEntrada"
          >
            La fecha de entrada es requerida
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="marca">Marca</label>
          <input
            type="text"
            id="marca"
            [(ngModel)]="product.marca"
            name="marca"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.marca"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.marca"
          >
            La marca es requerida
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="op">OP</label>
          <input
            type="number"
            id="op"
            [(ngModel)]="product.op"
            name="op"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.op"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.op"
          >
            El OP es requerido
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="camp">Camp</label>
          <input
            type="number"
            id="camp"
            [(ngModel)]="product.camp"
            name="camp"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.camp"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.camp"
          >
            El camp es requerido
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="tipo">Tipo</label>
          <input
            type="text"
            id="tipo"
            [(ngModel)]="product.tipo"
            name="tipo"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.tipo"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.tipo"
          >
            El tipo es requerido
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="talla">Talla</label>
          <button
            type="button"
            class="btn btn-outline-secondary form-control"
            (click)="openSizeModal()"
            [class.is-invalid]="productForm.submitted && (!product.talla)"
          >
            {{ product.talla ? 'Tallas seleccionadas (' + getSelectedSizesCount() + ')' : 'Seleccionar tallas' }}
          </button>
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.talla"
          >
            La talla es requerida
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="color">Precio</label>
          <input
            type="text"
            id="color"
            [(ngModel)]="product.price"
            name="color"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.price"
            required
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.price"
          >
            El precio es requerido
          </div>
        </div>

      </div>
      
    
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="module">Equipo</label>
          <button
            type="button"
            class="btn btn-outline-secondary form-control"
            (click)="openModuleModal()"
            [class.is-invalid]="productForm.submitted && !product.module"
            [disabled]="loading"
          >
            {{ product.module ? 'Equipo seleccionado: ' + product.module.name : 'Seleccionar equipo' }}
          </button>
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.module"
          >
            El equipo es requerido
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="stopReason">Descripción Paro</label>
          <select
            id="stopReason"
            [(ngModel)]="product.stoppageReason"
            name="stoppageReason"
            class="form-control">
            <option [ngValue]="''">-- Seleccionar razón --</option>
            <option *ngFor="let reason of stoppageReasons" [ngValue]="reason">
              {{ reason }}
            </option>
          </select>
          
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="status">Estado</label>
          <select
            id="status"
            [(ngModel)]="product.status"
            name="status"
            class="form-control"
          >
            <option [ngValue]="''">-- Seleccionar estado --</option>
            <option *ngFor="let statu of status" [ngValue]="statu">
              {{ statu }}
            </option>
          </select>

        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="sam">SAM</label>
          <input
            type="number"
            id="sam"
            [(ngModel)]="product.sam"
            name="sam"
            class="form-control"
            [class.is-invalid]="productForm.submitted && (!product.sam || product.sam <= 0)"
            required
            min="0.01"
            step="0.01"
          />
          <div class="invalid-feedback" *ngIf="productForm.submitted && (!product.sam || product.sam <= 0)">
            El SAM es requerido y debe ser mayor a 0
          </div>
        </div>
      </div>
      <div class="row">
      <div class="col-md-6">
       <div class="form-group mb-3">
        <label for="actualDeliveryDate">Fecha Entrega Real</label>
        <input
        type ="date"
          id="actualDeliveryDate"
          [(ngModel)]="product.actualDeliveryDate"
          name="actualDeliveryDate"
          class="form-control"
       >
     </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <label for="cantidadProducida">Cantidad Confeccionada</label>
          <input
            type="number"
            id="cantidadConfeccionada"
            [(ngModel)]="product.quantityMade"
            name="cantidadProducida"
            class="form-control">
          
           
          </div>
      </div>
    </div>
    </div>
      
      <div class="col-md-4">
        <div class="form-group mb-3">
          <label for="quantity">Total</label>
          <input
            type="number"
            id="quantity"
            [(ngModel)]="product.quantity"
            name="quantity"
            class="form-control"
            [class.is-invalid]="productForm.submitted && !product.quantity"
            required
            readonly
            [disabled]="loading"
          />
          <div
            class="invalid-feedback"
            *ngIf="productForm.submitted && !product.quantity"
          >
            El total es requerido
          </div>
        </div>
      </div>
    <div class="buttons d-flex gap-2">
      <button type="submit" class="btn btn-primary" [disabled]="loading">
        <i class="fas fa-save" *ngIf="!loading"></i>
        <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
        {{ loading ? 'Actualizando...' : 'Actualizar OP' }}
      </button>
      <button
        type="button"
        class="btn btn-secondary"
        (click)="volverAlInventario()"
        [disabled]="loading"
      >
        Cancelar
      </button>
    </div>
  </form>
</div>

<div class="modal" [ngClass]="{'show d-block': showSizeModal}" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Tallas y Cantidades</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeSizeModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Navegación entre secciones -->
        <div class="d-flex justify-content-center mb-3">
          <button
            type="button"
            class="btn btn-outline-primary me-2"
            [class.active]="activeSizeSection === 'kids'"
            (click)="showKidsSizes()">
            Tallas Niños
          </button>
          <button
            type="button"
            class="btn btn-outline-primary"
            [class.active]="activeSizeSection === 'adult'"
            (click)="showAdultSizes()">
            Tallas Adultos
          </button>
        </div>

        <!-- Sección de tallas de niños -->
        <div *ngIf="activeSizeSection === 'kids'">
          <h6 class="text-center mb-3">Tallas de Niños</h6>
          <div *ngFor="let size of kidsSizes" class="mb-2 d-flex align-items-center">
            <label class="me-2" style="width: 50px;">{{ size.name }}</label>
            <input type="number"  placeholder="0" min="0" [(ngModel)]="size.quantity" class="form-control" style="width: 100px;" />
          </div>
        </div>

        <!-- Sección de tallas de adultos -->
        <div *ngIf="activeSizeSection === 'adult'">
          <h6 class="text-center mb-3">Tallas de Adultos</h6>
          <div *ngFor="let size of adultSizes" class="mb-2 d-flex align-items-center">
            <label class="me-2" style="width: 50px;">{{ size.name }}</label>
            <input type="number" min="0"  placeholder="0" [(ngModel)]="size.quantity" class="form-control" style="width: 100px;" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeSizeModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="saveSizes()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE MÓDULOS -->
<div class="modal" id="moduleModal" tabindex="-1" [ngClass]="{'show d-block': showModuleModal}" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Equipo</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeModuleModal()"></button>
      </div>
      <div class="modal-body">
        <h6 class="text-center mb-3">Seleccionar Equipo</h6>
        <div class="list-group">
          <button
            type="button"
            class="list-group-item list-group-item-action"
            *ngFor="let mod of modules"
            (click)="selectModule(mod)">
            {{ mod.name }} - {{ mod.description }}
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModuleModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
